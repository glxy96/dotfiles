# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Personal dotfiles repository for macOS development environment synchronization across multiple machines. Contains shell configuration, editor settings, terminal emulator config, and Git/SSH settings.

## Repository Structure

```
dotfiles/
â”œâ”€â”€ brew/
â”‚   â”œâ”€â”€ Brewfile        # Homebrew package/app bundle definition (common)
â”‚   â””â”€â”€ Brewfile.music  # Music production environment (optional)
â”œâ”€â”€ zsh/
â”‚   â”œâ”€â”€ zshrc           # Zsh configuration (plugins, prompt, aliases)
â”‚   â”œâ”€â”€ zprofile        # PATH settings (Homebrew, Claude Code, pyenv, etc.)
â”‚   â””â”€â”€ git-prompt.sh   # Git prompt display script (from Git official repo)
â”œâ”€â”€ git/
â”‚   â”œâ”€â”€ config          # Git configuration
â”‚   â””â”€â”€ commit_template # Git commit template with emoji prefixes
â”œâ”€â”€ nvim/
â”‚   â””â”€â”€ init.lua        # Neovim configuration (lazy.nvim, Telescope, Treesitter)
â”œâ”€â”€ ghostty/
â”‚   â””â”€â”€ config          # Ghostty terminal emulator settings
â”œâ”€â”€ karabiner/          # Karabiner-Elements keyboard customization
â”‚   â”œâ”€â”€ karabiner.json  # Main configuration
â”‚   â””â”€â”€ assets/complex_modifications/  # Custom key mappings
â”œâ”€â”€ ssh/
â”‚   â”œâ”€â”€ config.template # GitHub SSH config template
â”‚   â””â”€â”€ config.d/       # Additional host configurations
â”‚       â””â”€â”€ home.conf   # Home network hosts (raspi, ubuntu, etc.)
â”œâ”€â”€ claude/
â”‚   â”œâ”€â”€ settings.json   # Claude Code global settings (model, hooks)
â”‚   â””â”€â”€ CLAUDE.md       # Claude Code global instructions
â””â”€â”€ scripts/
    â”œâ”€â”€ setup_ssh.sh    # SSH config setup script
    â””â”€â”€ notify_sound.sh # Cross-platform notification sound (used by Claude Code hooks)
```

## Symlink Strategy

This repository uses a specific symlink strategy to avoid circular link issues:

**Link entire directories:**
- `ghostty/` â†’ `~/.config/ghostty` (prevents circular link if directory exists first)
- `karabiner/` â†’ `~/.config/karabiner` (entire keyboard config directory)

**Link specific files only:**
- `zsh/zshrc` â†’ `~/.zshrc`
- `zsh/zprofile` â†’ `~/.zprofile`
- `git/config` â†’ `~/.gitconfig`
- `git/commit_template` â†’ `~/.commit_template`
- `nvim/init.lua` â†’ `~/.config/nvim/init.lua`
- `claude/settings.json` â†’ `~/.claude/settings.json`
- `claude/CLAUDE.md` â†’ `~/.claude/CLAUDE.md`

**Generated files (not symlinked):**
- `~/.ssh/config` - generated by `scripts/setup_ssh.sh` from template

## Git Workflow

Gitä½œæ¥­ãƒ«ãƒ¼ãƒ«ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ« `~/.claude/CLAUDE.md` ã‚’å‚ç…§ã€‚
ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚‚åŒã˜ãƒ«ãƒ¼ãƒ«ã«å¾“ã†ï¼ˆãƒ–ãƒ©ãƒ³ãƒä½œæˆ â†’ PR â†’ ãƒãƒ¼ã‚¸ â†’ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰ã€‚

### Commit Message Format

This repository uses emoji prefixes in commit messages (see .commit_template). Common ones:

- ğŸ“ `:memo:` - Documentation/comments
- âœ¨ `:sparkles:` - Feature addition (partial)
- ğŸ‘ `:+1:` - Feature improvement
- ğŸ› `:bug:` - Bug fix
- â™»ï¸ `:recycle:` - Refactoring
- ğŸ‘• `:shirt:` - Lint/code style fixes

## Cross-Machine Sync Considerations

When modifying configuration files, consider:

1. **External dependencies not in repo:**
   - Homebrew (required to install packages from Brewfile)
   - Zinit (auto-installed on first .zshrc source)
   - Language version managers (pyenv, fnm) - installed via Brewfile

2. **Machine-specific settings:**
   - `ssh/config`: Contains `Include /Users/ginga/.colima/ssh_config` (may not exist on all machines)
   - `ssh/config`: IdentityFile paths refer to private keys not in repo
   - `.gitconfig`: Username/email may need overriding per machine

3. **Files required for setup:**
   - `zsh/git-prompt.sh` must be in repo (referenced by zshrc)
   - Without this file, zsh initialization will fail on new machines

## Key Configuration Details

### Zsh Setup
- Uses Zinit for plugin management (auto-installs to `~/.local/share/zinit/`)
- Git prompt integration via `zsh/git-prompt.sh`
- PATH configuration in `zsh/zprofile` for Homebrew, Claude Code, pyenv, fnm

### Homebrew Setup
- `brew/Brewfile` defines all packages and applications to install
- `brew/Brewfile.music` defines music production environment (optional)
- Use `brew bundle --file=brew/Brewfile` to install all dependencies

### Karabiner-Elements Setup
- Custom key mappings for Japanese input switching (Command keys â†’ Eisuu/Kana)
- RDP-specific key remapping (Command â†” Option swap for Windows compatibility)
- Complex modifications stored in `karabiner/assets/complex_modifications/`

### Neovim Setup
- Uses lazy.nvim package manager (auto-bootstraps on first run)
- Configured for Markdown editing and PKM (Personal Knowledge Management)
- Requires `nvim --headless "+Lazy! sync" +qa` after initial setup

### PKM/Obsidian Integration
Neovim is configured for note-taking with expected directory structure:
```bash
~/pkm/{daily,weekly,inbox/temporary,templates}
```

### Claude Code Setup
- `claude/settings.json` contains global settings (default model, hooks)
- `claude/CLAUDE.md` contains global instructions for Git workflow and coding style
- Hooks: Notification sound on permission prompts (via `scripts/notify_sound.sh`)
  - macOS: System sound via `afplay`
  - Linux: Sound via `paplay` or `aplay`
  - WSL: Windows beep via PowerShell
- Default model: Sonnet

## Testing Changes

When modifying configuration files:

1. **Shell configs (.zshrc, .zprofile):**
   ```bash
   source ~/.zshrc  # Test if it loads without errors
   ```

2. **Neovim config (nvim/init.lua):**
   ```bash
   nvim --headless "+Lazy! sync" +qa  # Sync plugins
   nvim  # Open and check for errors
   ```

3. **SSH config:**
   ```bash
   ssh -T git@github.com  # Test GitHub connection
   ```

## Common Issues

1. **Circular symlinks with ghostty:**
   - Never `mkdir ~/.config/ghostty` before symlinking
   - Link the entire directory: `ln -sf ~/dotfiles/ghostty ~/.config/ghostty`

2. **Missing git-prompt.sh:**
   - Causes zsh initialization failure
   - Must be present in `zsh/` directory in repo

3. **Font not rendering correctly:**
   - Install HackGen Console NF: `brew install --cask font-hackgen-nerd`
